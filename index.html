<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Practice Caddie - v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #0a0f1d;
      --bg-card: #111827;
      --accent-green: #10b981;
      --accent-blue: #0ea5e9;
      --accent-red: #ef4444;
      --accent-gold: #fbbf24;
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
      --border: rgba(255, 255, 255, 0.1);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0; background: var(--bg-main); color: var(--text-main);
      display: flex; justify-content: center; padding: 20px; line-height: 1.5; min-height: 100vh;
    }

    .container { max-width: 480px; width: 100%; }

    .card {
      background: var(--bg-card); border-radius: 20px; border: 1px solid var(--border);
      padding: 24px; margin-bottom: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    h1 {
      font-size: 1.25rem; font-weight: 700; margin: 0;
      background: linear-gradient(to right, #fff, #9ca3af);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .badge {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 6px;
      background: rgba(16, 185, 129, 0.1); color: var(--accent-green); font-weight: 700;
    }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; }
    .stat-box {
      background: rgba(255,255,255,0.03); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px; text-align: center;
    }
    .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
    .stat-value { font-size: 1.1rem; font-weight: 700; color: white; }

    .input-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 6px; color: var(--text-muted); }

    input[type="number"], input[type="text"], textarea {
      width: 100%; background: #0a0f1d; border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px; color: white; font-size: 1rem; box-sizing: border-box;
    }

    .timer-container {
      background: #000; border-radius: 16px; padding: 32px 24px; text-align: center;
      position: relative; overflow: hidden; border: 1px solid var(--accent-blue); margin-bottom: 16px;
    }

    .progress-bar {
      position: absolute; bottom: 0; left: 0; height: 6px; background: var(--accent-blue);
      width: 100%; transition: width 0.25s linear;
    }

    .time-large { font-size: 4rem; font-weight: 800; font-variant-numeric: tabular-nums; margin: 8px 0; }

    .btn {
      width: 100%; padding: 14px; border-radius: 12px; font-weight: 600; cursor: pointer;
      border: none; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px;
    }
    .btn-primary { background: var(--accent-green); color: #064e3b; }
    .btn-secondary { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .star-rating {
      display: flex; flex-direction: row-reverse; justify-content: center; gap: 8px; margin: 12px 0;
    }
    .star-rating input { display: none; }
    .star-rating label { font-size: 2.5rem; color: #334155; cursor: pointer; transition: color 0.1s; }
    .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: var(--accent-gold); }

    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px;
    }
    .overlay.active { display: flex; }
    .overlay-card { 
      background: var(--bg-card); border-radius: 20px; padding: 24px; width: 100%; 
      max-width: 400px; border: 1px solid var(--border); max-height: 80vh; overflow-y: auto;
    }

    .list-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .small-links { display: flex; justify-content: center; gap: 16px; margin-top: 24px; padding-bottom: 40px; }
    .link-item { font-size: 0.75rem; color: var(--text-muted); cursor: pointer; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
      <div>
        <h1>Practice Caddie</h1>
        <div style="font-size:0.75rem; color: var(--text-muted)">v5 Trend Tracking</div>
      </div>
      <div id="pro-badge" class="badge">FREE</div>
    </div>

    <div class="card">
      <div class="stat-label" style="text-align:center; margin-bottom:10px;">Practice Statistics</div>
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Week</div>
          <div id="balls-week" class="stat-value">0</div>
          <div id="sub-week" class="stat-label" style="margin-top:4px; font-size:0.55rem;">0m • 0★</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Month</div>
          <div id="balls-month" class="stat-value">0</div>
          <div id="sub-month" class="stat-label" style="margin-top:4px; font-size:0.55rem;">0m • 0★</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Lifetime</div>
          <div id="balls-life" class="stat-value">0</div>
          <div id="sub-life" class="stat-label" style="margin-top:4px; font-size:0.55rem;">0m • 0★</div>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <div class="stat-label">Last Session Notes</div>
        <div id="last-notes" style="font-size: 0.8rem; color: #d1d5db; margin-top: 4px; font-style: italic;">No history yet.</div>
      </div>
    </div>

    <div class="card" id="setup-section">
      <div id="setup-header" style="font-weight: 700; margin-bottom: 16px; font-size: 0.8rem; color: var(--accent-blue); text-transform:uppercase;">Setup</div>
      <div class="grid-2">
        <div class="input-group">
          <label>Total Mins</label>
          <input type="number" id="total-mins" value="15" />
        </div>
        <div class="input-group">
          <label>No. Drills</label>
          <input type="number" id="num-drills" value="2" />
        </div>
      </div>
      <button id="auto-fill-btn" class="btn btn-secondary" style="margin-bottom: 20px; padding: 8px;">Auto-fill Segments</button>

      <div class="grid-2">
        <div class="input-group">
          <label>Warm-up</label>
          <input type="number" id="warmup-mins" value="2" />
        </div>
        <div class="input-group">
          <label>Wrap-up</label>
          <input type="number" id="wrapup-mins" value="3" />
        </div>
      </div>
      <div id="drills-container">
        <label>Drills (Minutes)</label>
        <div id="drills-grid" class="grid-2" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="timer-panel" style="display:none;">
      <div class="timer-container">
        <div class="stat-label" id="current-section-name">SECTION</div>
        <div class="time-large" id="time-remaining">00:00</div>
        <div id="next-section-label" class="stat-label" style="opacity: 0.6;">Next: --</div>
        <div class="progress-bar" id="timer-progress"></div>
      </div>
      <div class="grid-2" style="margin-bottom: 16px;">
        <button id="pause-btn" class="btn btn-secondary">Pause</button>
        <button id="stop-btn" class="btn btn-danger">Stop</button>
      </div>
    </div>

    <button id="start-btn" class="btn btn-primary">Start Practice Session</button>

    <div class="small-links">
      <span class="link-item" id="view-plans-link">Plans</span>
      <span class="link-item" id="view-history-link">History</span>
      <span class="link-item" id="reset-all-link" style="color:#ef4444">Reset All</span>
      <span class="link-item" id="toggle-pro-link">Debug Pro</span>
    </div>
  </div>

  <div class="overlay" id="session-end-overlay">
    <div class="overlay-card">
      <h2 style="margin-top:0">Session Complete</h2>
      <div class="input-group">
        <label>Rating</label>
        <div class="star-rating">
          <input type="radio" id="star5" name="rating" value="5" /><label for="star5">★</label>
          <input type="radio" id="star4" name="rating" value="4" /><label for="star4">★</label>
          <input type="radio" id="star3" name="rating" value="3" /><label for="star3">★</label>
          <input type="radio" id="star2" name="rating" value="2" /><label for="star2">★</label>
          <input type="radio" id="star1" name="rating" value="1" /><label for="star1">★</label>
          <input type="radio" id="star0" name="rating" value="0" checked style="display:none"/>
        </div>
      </div>
      <div class="grid-2">
        <div class="input-group">
          <label>Balls Hit</label>
          <input type="number" id="balls-hit-input" value="0" />
        </div>
        <div class="input-group">
          <label>Time: <span id="actual-time-display">0</span>m</label>
        </div>
      </div>
      <div class="input-group"><label>Notes</label><textarea id="notes-input" placeholder="Feedback..."></textarea></div>
      <div class="grid-2">
        <button class="btn btn-secondary" id="skip-log-btn">Skip</button>
        <button class="btn btn-primary" id="save-log-btn">Save</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="history-overlay"><div class="overlay-card"><h2>History</h2><div id="history-list"></div><button class="btn btn-secondary" id="close-history-btn" style="margin-top:16px">Close</button></div></div>
  <div class="overlay" id="plans-overlay"><div class="overlay-card"><h2>Plans</h2><input type="text" id="new-plan-name" placeholder="Plan Name" /><button class="btn btn-primary" id="save-current-plan-btn" style="margin:12px 0">Save Current Setup</button><div id="plans-list"></div><button class="btn btn-secondary" id="close-plans-btn" style="margin-top:16px">Close</button></div></div>

  <script>
    (function() {
      const STORAGE_SESSIONS = 'golfPracticeSessionsV5';
      const STORAGE_PLANS = 'golfPracticePlansV5';
      const STORAGE_LAST_STATE = 'golfPracticeLastStateV5';
      const STORAGE_PRO = 'golfPracticeDebugIsPro';
      
      let Entitlement = { isPro: false };
      let timerId = null, sectionsRuntime = [], currentSectionIndex = 0, sectionEndTimestamp = 0, sectionDurationSec = 0, sessionRunning = false, isPaused = false, pausedRemainingSec = 0, drillInputs = [], sessionStartTime = 0, totalPausedMs = 0, pauseStartTime = 0;

      const elements = {
        ballsWeek: document.getElementById('balls-week'), subWeek: document.getElementById('sub-week'),
        ballsMonth: document.getElementById('balls-month'), subMonth: document.getElementById('sub-month'),
        ballsLife: document.getElementById('balls-life'), subLife: document.getElementById('sub-life'),
        lastNotes: document.getElementById('last-notes'),
        totalMins: document.getElementById('total-mins'), numDrills: document.getElementById('num-drills'),
        warmup: document.getElementById('warmup-mins'), wrapup: document.getElementById('wrapup-mins'),
        drillsGrid: document.getElementById('drills-grid'), timerPanel: document.getElementById('timer-panel'),
        setupSection: document.getElementById('setup-section'), setupHeader: document.getElementById('setup-header'),
        currentSectionName: document.getElementById('current-section-name'), timeRemaining: document.getElementById('time-remaining'),
        nextSection: document.getElementById('next-section-label'), progressBar: document.getElementById('timer-progress'),
        startBtn: document.getElementById('start-btn'), pauseBtn: document.getElementById('pause-btn'), stopBtn: document.getElementById('stop-btn')
      };

      function formatSeconds(sec) { return `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`; }
      
      function rebuildDrills(count, values = []) {
        elements.drillsGrid.innerHTML = ''; drillInputs = [];
        for (let i = 0; i < count; i++) {
          const input = document.createElement('input'); input.type = 'number'; input.value = values[i] || '0';
          elements.drillsGrid.appendChild(input); drillInputs.push(input);
          input.onchange = saveState;
        }
      }

      function saveState() {
        const state = { totalMins: elements.totalMins.value, numDrills: elements.numDrills.value, warmup: elements.warmup.value, wrapup: elements.wrapup.value, drills: drillInputs.map(i => i.value), headerText: elements.setupHeader.textContent };
        localStorage.setItem(STORAGE_LAST_STATE, JSON.stringify(state));
      }

      function loadLastState() {
        const saved = localStorage.getItem(STORAGE_LAST_STATE);
        if (saved) {
          const s = JSON.parse(saved);
          elements.totalMins.value = s.totalMins; elements.numDrills.value = s.numDrills;
          elements.warmup.value = s.warmup; elements.wrapup.value = s.wrapup;
          elements.setupHeader.textContent = s.headerText || "SETUP";
          rebuildDrills(s.numDrills, s.drills);
        } else {
          elements.totalMins.value = 15; elements.numDrills.value = 2; elements.warmup.value = 2; elements.wrapup.value = 3;
          rebuildDrills(2, [5, 5]); elements.setupHeader.textContent = "SETUP";
        }
      }

      function loadStats() {
        const history = JSON.parse(localStorage.getItem(STORAGE_SESSIONS) || '[]');
        Entitlement.isPro = localStorage.getItem(STORAGE_PRO) === '1';
        document.getElementById('pro-badge').textContent = Entitlement.isPro ? 'PRO' : 'FREE';
        const now = Date.now();
        const calc = (days) => {
          const filtered = days ? history.filter(s => (now - s.timestamp) < days * 86400000) : history;
          const b = filtered.reduce((a, s) => a + s.balls, 0);
          const m = filtered.reduce((a, s) => a + s.actualMins, 0);
          const r = filtered.filter(s => s.rating > 0).map(s => s.rating);
          const avg = r.length ? (r.reduce((a, b) => a + b, 0) / r.length).toFixed(1) : '0';
          return { b, m, avg };
        };
        const w = calc(7), m = calc(30), l = calc(0);
        elements.ballsWeek.textContent = w.b; elements.subWeek.textContent = `${w.m}m • ${w.avg}★`;
        elements.ballsMonth.textContent = m.b; elements.subMonth.textContent = `${m.m}m • ${m.avg}★`;
        elements.ballsLife.textContent = l.b; elements.subLife.textContent = `${l.m}m • ${l.avg}★`;
        elements.lastNotes.textContent = history[0]?.notes || "No history yet.";
        const blur = Entitlement.isPro ? 'none' : 'blur(4px)';
        [elements.ballsWeek, elements.subWeek, elements.ballsMonth, elements.subMonth, elements.ballsLife, elements.subLife, elements.lastNotes].forEach(el => el.style.filter = blur);
      }

      function updateTimer() {
        if (!sessionRunning || isPaused) return;
        const rem = Math.ceil((sectionEndTimestamp - Date.now()) / 1000);
        if (rem <= 0) { skipSection(); return; }
        elements.timeRemaining.textContent = formatSeconds(rem);
        elements.progressBar.style.width = ((rem / sectionDurationSec) * 100) + "%";
      }

      function beginSection() {
        const s = sectionsRuntime[currentSectionIndex];
        sectionDurationSec = s.durationSec; sectionEndTimestamp = Date.now() + (s.durationSec * 1000);
        elements.currentSectionName.textContent = s.name; elements.timeRemaining.textContent = formatSeconds(s.durationSec);
        elements.nextSection.textContent = sectionsRuntime[currentSectionIndex + 1] ? `Next: ${sectionsRuntime[currentSectionIndex + 1].name}` : "Next: Done";
        clearInterval(timerId); timerId = setInterval(updateTimer, 250);
      }

      function skipSection() {
        currentSectionIndex++;
        if (currentSectionIndex >= sectionsRuntime.length) { endSession(true); } else { beginSection(); }
      }

      function startSession() {
        const durs = [];
        if (elements.warmup.value > 0) durs.push({ name: 'Warm-up', durationSec: elements.warmup.value * 60 });
        drillInputs.forEach((i, idx) => { if (i.value > 0) durs.push({ name: `Drill ${idx+1}`, durationSec: i.value * 60 }); });
        if (elements.wrapup.value > 0) durs.push({ name: 'Wrap-up', durationSec: elements.wrapup.value * 60 });
        if (!durs.length) return;
        sectionsRuntime = durs; currentSectionIndex = 0; sessionRunning = true; sessionStartTime = Date.now();
        elements.timerPanel.style.display = 'block'; elements.setupSection.style.display = 'none';
        elements.startBtn.textContent = "Skip Section"; elements.startBtn.classList.replace('btn-primary', 'btn-secondary');
        beginSection();
      }

      function endSession(showLog) {
        sessionRunning = false; clearInterval(timerId);
        elements.timerPanel.style.display = 'none'; elements.setupSection.style.display = 'block';
        elements.startBtn.textContent = "Start Practice Session"; elements.startBtn.classList.replace('btn-secondary', 'btn-primary');
        if (showLog) {
          document.getElementById('actual-time-display').textContent = Math.round((Date.now() - sessionStartTime - totalPausedMs) / 60000);
          document.getElementById('session-end-overlay').classList.add('active');
        }
      }

      elements.startBtn.onclick = () => sessionRunning ? skipSection() : startSession();
      elements.pauseBtn.onclick = () => {
        isPaused = !isPaused;
        if (isPaused) { pauseStartTime = Date.now(); pausedRemainingSec = Math.ceil((sectionEndTimestamp - Date.now()) / 1000); clearInterval(timerId); elements.pauseBtn.textContent = "Resume"; }
        else { totalPausedMs += (Date.now() - pauseStartTime); sectionEndTimestamp = Date.now() + (pausedRemainingSec * 1000); timerId = setInterval(updateTimer, 250); elements.pauseBtn.textContent = "Pause"; }
      };
      elements.stopBtn.onclick = () => confirm("End early?") && endSession(true);

      document.getElementById('save-log-btn').onclick = () => {
        const history = JSON.parse(localStorage.getItem(STORAGE_SESSIONS) || '[]');
        const rating = parseInt(document.querySelector('input[name="rating"]:checked').value);
        history.unshift({ timestamp: Date.now(), balls: parseInt(document.getElementById('balls-hit-input').value) || 0, actualMins: parseInt(document.getElementById('actual-time-display').textContent) || 0, rating, notes: Entitlement.isPro ? document.getElementById('notes-input').value : '' });
        localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(history));
        loadStats(); document.getElementById('session-end-overlay').classList.remove('active');
      };

      document.getElementById('auto-fill-btn').onclick = () => {
        const total = parseInt(elements.totalMins.value) || 15;
        elements.warmup.value = 2; elements.wrapup.value = 3;
        const count = parseInt(elements.numDrills.value) || 1;
        const perDrill = Math.floor((total - 5) / count);
        rebuildDrills(count, Array(count).fill(perDrill));
        elements.setupHeader.textContent = "SETUP"; saveState();
      };

      document.getElementById('reset-all-link').onclick = () => { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } };
      document.getElementById('toggle-pro-link').onclick = () => { localStorage.setItem(STORAGE_PRO, Entitlement.isPro ? '0' : '1'); loadStats(); };
      document.getElementById('skip-log-btn').onclick = () => document.getElementById('session-end-overlay').classList.remove('active');
      document.getElementById('view-history-link').onclick = () => document.getElementById('history-overlay').classList.add('active');
      document.getElementById('close-history-btn').onclick = () => document.getElementById('history-overlay').classList.remove('active');
      document.getElementById('view-plans-link').onclick = () => document.getElementById('plans-overlay').classList.add('active');
      document.getElementById('close-plans-btn').onclick = () => document.getElementById('plans-overlay').classList.remove('active');

      elements.numDrills.onchange = () => { rebuildDrills(parseInt(elements.numDrills.value) || 1); elements.setupHeader.textContent = "SETUP"; saveState(); };
      elements.totalMins.onchange = elements.warmup.onchange = elements.wrapup.onchange = () => { elements.setupHeader.textContent = "SETUP"; saveState(); };

      loadLastState(); loadStats();
    })();
  </script>
</body>
</html>
