<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Caddie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root{
          --bg-primary:#F7F8F6;
          --surface-primary:#FFFFFF;
          --border-subtle:#D9DED8;
          --text-primary:#1F2A24;
          --text-secondary:#5F6D64;
          --accent-primary:#2F6F4E;
          --accent-primary-dark:#275C41;
          --focus-ring:rgba(47,111,78,.35);
          --danger:#9B2C2C;
        }
        html,body{height:100%}
        body.pc-body{
          background: radial-gradient(1200px 600px at 20% 0%, rgba(47,111,78,.08), transparent 55%),
                      radial-gradient(900px 500px at 90% 10%, rgba(95,109,100,.08), transparent 60%),
                      var(--bg-primary);
          color:var(--text-primary);
          -webkit-font-smoothing:antialiased;
          -moz-osx-font-smoothing:grayscale;
        }
        .pc-card{
          background:var(--surface-primary);
          border:1px solid var(--border-subtle);
          border-radius:14px;
          box-shadow:0 1px 2px rgba(0,0,0,.05);
        }
        .pc-card-strong{
          background:var(--surface-primary);
          border:1px solid var(--border-subtle);
          border-radius:16px;
          box-shadow:0 10px 24px rgba(31,42,36,.10);
        }
        .pc-rule{border-top:1px solid var(--border-subtle)}
        .pc-accent-rule{height:2px;background:var(--accent-primary);border-radius:999px}
        .pc-focus:focus{outline:none; box-shadow:0 0 0 3px var(--focus-ring); border-color:var(--accent-primary)}
        input.pc-input, select.pc-input, textarea.pc-input{
          background:var(--surface-primary);
          border:1px solid var(--border-subtle);
          border-radius:12px;
          padding:.6rem .8rem;
          width:100%;
        }
        input.pc-input::placeholder, textarea.pc-input::placeholder{color:rgba(95,109,100,.75)}
        .pc-btn{
          border-radius:12px;
          font-weight:600;
          padding:.75rem 1rem;
          transition:transform .02s ease, background-color .15s ease, border-color .15s ease, color .15s ease;
          -webkit-tap-highlight-color:transparent;
        }
        .pc-btn:active{transform:translateY(1px)}
        .pc-btn-primary{background:var(--accent-primary); color:#fff}
        .pc-btn-primary:hover{background:var(--accent-primary-dark)}
        .pc-btn-secondary{background:#F0F2F0; color:var(--text-primary); border:1px solid var(--border-subtle)}
        .pc-btn-secondary:hover{background:#E8ECE9}
        .pc-btn-danger{background:var(--danger); color:#fff}
        .pc-btn-danger:hover{filter:brightness(.92)}
        .pc-link{color:var(--accent-primary)}
        .pc-link:hover{color:var(--accent-primary-dark); text-decoration:underline}
        .pc-tile{
          background:var(--surface-primary);
          border:1px solid var(--border-subtle);
          border-radius:16px;
          padding:1.25rem;
          text-align:left;
          box-shadow:0 1px 2px rgba(0,0,0,.05);
          transition:transform .02s ease, border-color .15s ease, box-shadow .15s ease;
          -webkit-tap-highlight-color:transparent;
        }
        .pc-tile:hover{border-color:rgba(47,111,78,.35); box-shadow:0 6px 16px rgba(31,42,36,.08)}
        .pc-tile:active{transform:translateY(1px)}
        .pc-tile-icon{
          width:42px;height:42px;border-radius:12px;
          display:flex;align-items:center;justify-content:center;
          background:rgba(47,111,78,.10);
          color:var(--accent-primary);
          font-size:20px;
          margin-bottom:.75rem;
        }
        .pc-session-bg{
          background: radial-gradient(900px 500px at 30% 0%, rgba(47,111,78,.25), transparent 60%),
                      radial-gradient(900px 500px at 90% 20%, rgba(95,109,100,.18), transparent 60%),
                      linear-gradient(180deg, #0F1713 0%, #16241D 100%);
        }
    </style>
</head>
<body class="min-h-screen pc-body">
<div id="app" class="max-w-2xl mx-auto p-4"></div>

<script>
    let app = {
      view: 'home',
      isPro: false,
      routines: [],
      plans: [],
      activePlanId: null,
      history: [],
      statsHistory: [],
      session: null,
      timer: null,
      segmentIndex: 0,
      timeLeft: 0,
      editRoutine: null,
      editPlan: null,
      quickSetup: { totalMinutes: 15, numDrills: 2 },
      deleteConfirm: null,
      showClearConfirm: false,
      statsResetConfirm: null,
      statsResetWeekAt: null,
      statsResetMonthAt: null,
      statsResetLifetimeAt: null,
      showUpgradeOverlay: false,
      hasLoaded: false,
      isPaused: false,
    };

    // --- Android Billing bridge (Pro entitlement) ---
    // Native Android pushes updates via: window.__androidBilling.onProStatusChanged(isPro, source)
    // If the push arrives before this handler exists, native stores window.__androidPro / window.__androidProSource.
    function applyProStatus(isPro, source) {
      try {
        const next = !!isPro;
        if (app.isPro !== next) {
          app.isPro = next;
        }
        // Avoid overwriting persisted data before initial load completes.
        if (app.hasLoaded) {
          save();
        }
        console.log('Pro status applied:', next, 'source:', source);
        render();
      } catch (e) {
        console.log('applyProStatus error:', e);
      }
    }

    window.__androidBilling = window.__androidBilling || {};
    window.__androidBilling.onProStatusChanged = (isPro, source) => {
      applyProStatus(isPro, source);
    };

    // Consume any buffered native value (if native fired before JS was ready)
    if (typeof window.__androidPro !== 'undefined') {
      applyProStatus(!!window.__androidPro, window.__androidProSource || 'native-buffer');
    }

    // Pull current value from the JS bridge on startup (robust even if no callback fires)
    try {
      if (window.AndroidBilling && typeof window.AndroidBilling.getProStatus === 'function') {
        const current = !!window.AndroidBilling.getProStatus();
        applyProStatus(current, 'getProStatus');
      }
    } catch (e) {
      console.log('AndroidBilling.getProStatus failed:', e);
    }
    // --- end Android Billing bridge ---



    // Storage
    async function save() {
      try {
        const data = JSON.stringify({
          isPro: app.isPro,
          routines: app.routines,
          plans: app.plans,
          activePlanId: app.activePlanId,
          history: app.history,
          statsHistory: app.statsHistory,
          statsResetWeekAt: app.statsResetWeekAt,
          statsResetMonthAt: app.statsResetMonthAt,
        });

        // Try persistent storage first, fallback to localStorage
        try {
          await window.storage.set('golfApp', data);
        } catch(e) {
          localStorage.setItem('golfApp', data);
        }
      } catch(e) {
        console.log('Save failed:', e);
      }
    }

    async function load() {
      try {
        let dataStr = null;

        // Try persistent storage first, fallback to localStorage
        try {
          const data = await window.storage.get('golfApp');
          if (data && data.value) {
            dataStr = data.value;
          }
        } catch(e) {
          dataStr = localStorage.getItem('golfApp');
        }

        if (dataStr) {
          const parsed = JSON.parse(dataStr);
          app.isPro = parsed.isPro || false;
          app.routines = parsed.routines || [];
          app.plans = parsed.plans || [];
          app.activePlanId = parsed.activePlanId || null;
          app.history = parsed.history || [];
          app.statsHistory = parsed.statsHistory || parsed.history || [];
        }

        // Add default routine if none exist
        if (app.routines.length === 0) {
          app.routines.push({
            id: 'default-' + Date.now(),
            name: 'Default Routine',
            segments: [
              { name: 'Warm-up', minutes: 2 },
              { name: 'Drill 1', minutes: 5 },
              { name: 'Drill 2', minutes: 5 },
              { name: 'Full swings', minutes: 3 }
            ]
          });
          await save();
        }
      } catch(e) {
        console.log('Load error:', e);
        // Add default routine for first-time users
        app.routines.push({
          id: 'default-' + Date.now(),
          name: 'Default Routine',
          segments: [
            { name: 'Warm-up', minutes: 2 },
            { name: 'Drill 1', minutes: 5 },
            { name: 'Drill 2', minutes: 5 },
            { name: 'Full swings', minutes: 3 }
          ]
        });
        await save();
      }
      app.hasLoaded = true;
      render();
    }

    // Timer
    function startTimer() {
      if (app.timer) clearInterval(app.timer);
      app.timer = setInterval(() => {
        app.timeLeft--;
        if (app.timeLeft <= 0) {
          if (app.segmentIndex < app.session.segments.length - 1) {
            app.segmentIndex++;
            const seg = app.session.segments[app.segmentIndex];
            app.timeLeft = seg.minutes * 60;
            announce(seg.name);
        } else {
          announceComplete();
          stopTimer();
          app.view = 'complete';
        }
        }
        render();
      }, 1000);
    }

    function stopTimer() {
      if (app.timer) clearInterval(app.timer);
      app.timer = null;
    }

    function announce(name) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 800;
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start();
      osc.stop(ctx.currentTime + 0.5);
        setTimeout(() => {
          const text = 'Next: ' + name;
          if (window.AndroidTTS && typeof window.AndroidTTS.speak === 'function') {
            window.AndroidTTS.speak(text);
          } else {
            const u = new SpeechSynthesisUtterance(text);
            u.volume = 1;
            speechSynthesis.speak(u);
          }
        }, 600);
    }

    function announceComplete() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.frequency.value = 800;
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
      osc.start();
      osc.stop(ctx.currentTime + 0.5);
      setTimeout(() => {
        const text = 'Routine complete.';
        if (window.AndroidTTS && typeof window.AndroidTTS.speak === 'function') {
          window.AndroidTTS.speak(text);
        } else {
          const u = new SpeechSynthesisUtterance(text);
          u.volume = 1;
          speechSynthesis.speak(u);
        }
      }, 600);
    }


    // Actions
    window.goTo = (view) => {
      app._navStack = app._navStack || [];
      if (app.view && app.view !== view) app._navStack.push(app.view);
      app.view = view;
      render();
    };

    window.__handleAndroidBack = () => {
      if (app.showUpgradeOverlay) {
        app.showUpgradeOverlay = false;
        render();
        return true;
      }
      if (app._navStack && app._navStack.length) {
        app.view = app._navStack.pop();
        render();
        return true;
      }
      return false;
    };


    window.__handleAndroidBack = () => {
      if (app.showUpgradeOverlay) {
        app.showUpgradeOverlay = false;
        render();
        return true;
      }
      if (app.view && app.view !== 'home') {
        goTo('home');
        return true;
      }
      return false;
    };

    window.togglePro = () => {
      app.isPro = !app.isPro;
      save();
      render();
    };

    window.showUpgrade = () => {
      app.showUpgradeOverlay = true;
      render();
    };

    window.closeUpgrade = () => {
      app.showUpgradeOverlay = false;
      render();
    };

    window.upgradeToPro = () => {
      try {
        if (window.AndroidBilling && typeof window.AndroidBilling.startPurchase === 'function') {
          window.AndroidBilling.startPurchase();
        } else {
          alert('Billing is not available yet. Please try again in a moment.');
          console.log('AndroidBilling.startPurchase not available');
        }
      } catch (e) {
        console.log('startPurchase failed:', e);
        alert('Could not start purchase. Please try again.');
      }
    };


    window.clearStorage = async () => {
      console.log('clearStorage called');
      app.showClearConfirm = true;
      console.log('showClearConfirm set to:', app.showClearConfirm);
      const root = document.getElementById('app');
      if (app.view === 'settings') {
        renderSettingsView(root);
      }
    };

    window.confirmClearStorage = async () => {
      console.log('User confirmed, clearing...');
      try {
        try {
          await window.storage.delete('golfApp');
          console.log('Window storage deleted');
        } catch(e) {
          console.log('Window storage failed, using localStorage:', e);
          localStorage.removeItem('golfApp');
          console.log('localStorage cleared');
        }
        console.log('About to reload...');
        location.reload();
      } catch(e) {
        console.log('Clear failed:', e);
        alert('Clear failed: ' + e.message);
      }
    };

    window.cancelClearStorage = () => {
      app.showClearConfirm = false;
      const root = document.getElementById('app');
      if (app.view === 'settings') {
        renderSettingsView(root);
      }
    };

    window.startRoutine = (id) => {
      const routine = app.routines.find(r => r.id === id);
      if (!routine || routine.segments.length === 0) return;

      // Acquire wake lock to keep screen on
      if (typeof AndroidWakeLock !== 'undefined') {
        try {
          AndroidWakeLock.acquireWakeLock();
        } catch (e) {
          console.error('Failed to acquire wake lock:', e);
        }
      }

      app.session = {
        routineId: routine.id,
        name: routine.name,
        segments: routine.segments,
        startTime: new Date().toISOString()
      };
      app.segmentIndex = 0;
      app.timeLeft = routine.segments[0].minutes * 60;
      app.view = 'session';
      app.isPaused = false;
      announce(routine.segments[0].name);
      startTimer();
      render();
    };

    window.skipSegment = () => {
      if (app.segmentIndex < app.session.segments.length - 1) {
        app.segmentIndex++;
        const seg = app.session.segments[app.segmentIndex];
        app.timeLeft = seg.minutes * 60;
        announce(seg.name);
        } else {
          announceComplete();
          stopTimer();
          app.view = 'complete';
        }
      render();
    };

    window.pauseRoutine = () => {
      stopTimer();
      app.isPaused = true;
      render();
    };

    window.continueRoutine = () => {
      app.isPaused = false;
      startTimer();
      render();
    };


    window.endSession = () => {
      stopTimer();

      // Release wake lock
      if (typeof AndroidWakeLock !== 'undefined') {
        try {
          AndroidWakeLock.releaseWakeLock();
        } catch (e) {
          console.error('Failed to release wake lock:', e);
        }
      }

      app.view = 'complete';
      render();
    };

    window.saveSession = () => {
      const balls = parseInt(document.getElementById('balls').value) || 0;
      const rating = parseInt(document.querySelector('.rating-selected')?.dataset.rating || 0);
      const notes = document.getElementById('notes').value;

      // Release wake lock
      if (typeof AndroidWakeLock !== 'undefined') {
        try {
          AndroidWakeLock.releaseWakeLock();
        } catch (e) {
          console.error('Failed to release wake lock:', e);
        }
      }

      const total = app.session.segments.reduce((s, seg) => s + seg.minutes, 0);
      app.history.unshift({
        id: Date.now().toString(),
        date: new Date().toISOString(),
        routineName: app.session.name,
        segments: app.session.segments,
        totalMinutes: total,
        ballsHit: balls,
        rating: rating,
        notes: notes
      });
      app.statsHistory.unshift(app.history[0]);

      // If there's an active plan, add this session's data to it
      if (app.activePlanId) {
        const activePlan = app.plans.find(p => p.id === app.activePlanId);
        if (activePlan) {
          if (!activePlan.progress) {
            activePlan.progress = { minutes: 0, balls: 0, sessions: 0 };
          }
          activePlan.progress.minutes += total;
          activePlan.progress.balls += balls;
          activePlan.progress.sessions += 1;
        }
      }

      app.session = null;
      app.view = 'home';
      save();
      render();
    };

    window.discardSession = () => {
      // Release wake lock
      if (typeof AndroidWakeLock !== 'undefined') {
        try {
          AndroidWakeLock.releaseWakeLock();
        } catch (e) {
          console.error('Failed to release wake lock:', e);
        }
      }

      app.session = null;
      app.view = 'home';
      render();
    };

    window.selectRating = (val) => {
      document.querySelectorAll('[data-rating]').forEach(btn => {
        btn.className = 'w-12 h-12 rounded-lg border-2 font-bold bg-white text-gray-600 border-gray-300';
      });
      event.target.className = 'w-12 h-12 rounded-lg border-2 font-bold bg-green-600 text-white border-[#2F6F4E] rating-selected';
    };

    window.newRoutine = () => {
      app.editRoutine = { id: Date.now().toString(), name: '', segments: [], isNew: true };
      app.view = 'editRoutine';
      render();
    };

    window.quickGenerate = () => {
      const total = parseInt(document.getElementById('quickTotal').value) || 15;
      const numDrills = parseInt(document.getElementById('quickDrills').value) || 2;

      // Fixed times for warm-up and full swings
      const warmupTime = 2;
      const fullSwingTime = 3;
      const remainingTime = total - warmupTime - fullSwingTime;

      if (remainingTime < numDrills) {
        alert('Not enough time for that many drills. Increase total time or reduce drills.');
        return;
      }

      const drillTime = Math.floor(remainingTime / numDrills);

      // Preserve the routine name
      const currentName = document.getElementById('rname').value;

      app.editRoutine.segments = [
        { name: 'Warm-up', minutes: warmupTime }
      ];

      for (let i = 1; i <= numDrills; i++) {
        app.editRoutine.segments.push({ name: `Drill ${i}`, minutes: drillTime });
      }

      app.editRoutine.segments.push({ name: 'Full swings', minutes: fullSwingTime });

      render();

      // Restore the name after render
      setTimeout(() => {
        document.getElementById('rname').value = currentName;
      }, 0);
    };

    window.editRoutineById = (id) => {
      app.editRoutine = app.routines.find(r => r.id === id);
      app.view = 'editRoutine';
      render();
    };

    window.deleteRoutine = (id) => {
      const routine = app.routines.find(r => r.id === id);
      app.deleteConfirm = { id, name: routine?.name || 'this routine' };

      // Force re-render without changing view
      const root = document.getElementById('app');
      if (app.view === 'routines') {
        renderRoutinesView(root);
      }
    };

    window.confirmDelete = () => {
      app.routines = app.routines.filter(r => r.id !== app.deleteConfirm.id);
      app.deleteConfirm = null;
      save();
      const root = document.getElementById('app');
      if (app.view === 'routines') {
        renderRoutinesView(root);
      }
    };

    window.cancelDelete = () => {
      app.deleteConfirm = null;
      const root = document.getElementById('app');
      if (app.view === 'routines') {
        renderRoutinesView(root);
      }
    };

    function renderRoutinesView(root) {
      const canAdd = app.isPro || app.routines.length < 3;
      root.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
          <h2 class="text-2xl font-bold">Routines</h2>
          <div class="w-16"></div>
        </div>

        ${app.deleteConfirm ? `
          <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-4">
            <p class="font-bold text-red-900 mb-3">Delete "${app.deleteConfirm.name}"?</p>
            <div class="flex gap-3">
              <button onclick="confirmDelete()" class="flex-1 pc-btn pc-btn-danger">Delete</button>
              <button onclick="cancelDelete()" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
            </div>
          </div>
        ` : ''}

        ${app.routines.length === 0 ? `
          <div class="pc-card p-8 text-center mb-4">
            <p class="text-gray-600">No routines yet!</p>
          </div>
        ` : `
          <div class="space-y-4 mb-4">
          ${app.routines.map(r => `
            <div class="pc-card p-4">
              <div class="flex justify-between mb-2">
                <div>
                  <h3 class="font-bold text-lg">${r.name}</h3>
                  <p class="text-sm text-gray-600">${r.segments.length} segments ‚Ä¢ ${r.segments.reduce((s,g) => s + g.minutes, 0)} min</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="editRoutineById('${r.id}')" class="p-2 hover:bg-gray-100 rounded">‚úèÔ∏è</button>
                  <button onclick="deleteRoutine('${r.id}'); return false;" class="p-2 hover:bg-gray-100 rounded">üóëÔ∏è</button>
                </div>
              </div>
              <button onclick="startRoutine('${r.id}')" class="w-full pc-btn pc-btn-primary">Start</button>
            </div>
          `).join('')}
          </div>
        `}

        ${canAdd ? `
          <button onclick="newRoutine()" class="w-full pc-btn pc-btn-secondary">+ Create Routine</button>
        ` : `
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
            <p class="text-orange-800">Free: 3 routines max. Upgrade to Pro!</p>
          </div>
        `}
      `;
    }

    function renderPlansView(root) {
      const canAdd = app.isPro || app.plans.length < 1;

      root.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
          <h2 class="text-2xl font-bold">Training Plans</h2>
          <div class="w-16"></div>
        </div>

        ${app.deletePlanConfirm ? `
          <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-4">
            <p class="font-bold text-red-900 mb-3">Delete "${app.deletePlanConfirm.name}"?</p>
            <div class="flex gap-3">
              <button onclick="confirmDeletePlan()" class="flex-1 pc-btn pc-btn-danger">Delete</button>
              <button onclick="cancelDeletePlan()" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
            </div>
          </div>
        ` : ''}

        ${app.plans.length === 0 ? `
          <div class="pc-card p-8 text-center mb-4">
            <p class="text-gray-600">No training plans yet!</p>
          </div>
        ` : `
          <div class="space-y-4 mb-4">
          ${app.plans.map(p => {
            if (!p.progress) {
              p.progress = { minutes: 0, balls: 0, sessions: 0 };
            }

            let current = 0;
            if (p.goalType === 'minutes') {
              current = p.progress.minutes;
            } else if (p.goalType === 'balls') {
              current = p.progress.balls;
            } else if (p.goalType === 'sessions') {
              current = p.progress.sessions;
            }

            const progress = Math.min((current / p.goalValue) * 100, 100);
            const isActive = app.activePlanId === p.id;

            return `
              <div class="pc-card p-4 ${isActive ? 'border-2 border-[#2F6F4E]' : ''}">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">${p.name} ${isActive ? '<span class="text-[#2F6F4E] text-sm">‚óè Active</span>' : ''}</h3>
                    <p class="text-sm text-gray-600">${p.goalValue} ${p.goalType} ‚Ä¢ Started ${new Date(p.startDate).toLocaleDateString()}</p>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="resetPlan('${p.id}')" class="p-2 hover:bg-gray-100 rounded" title="Reset start date">üîÑ</button>
                    <button onclick="editPlanById('${p.id}')" class="p-2 hover:bg-gray-100 rounded">‚úèÔ∏è</button>
                    <button onclick="deletePlan('${p.id}'); return false;" class="p-2 hover:bg-gray-100 rounded">üóëÔ∏è</button>
                  </div>
                </div>

                <div class="mb-3">
                  <div class="flex justify-between text-sm mb-1">
                    <span class="text-gray-600">${current} / ${p.goalValue} ${p.goalType}</span>
                    <span class="text-gray-600">${progress.toFixed(0)}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="bg-green-600 h-3 rounded-full transition-all" style="width:${progress}%"></div>
                  </div>
                </div>

                ${!isActive ? `
                  <button onclick="setActivePlan('${p.id}')" class="w-full pc-btn pc-btn-secondary">Set as Active</button>
                ` : `
                  <button onclick="deactivatePlan()" class="w-full pc-btn pc-btn-secondary">Deactivate</button>
                `}
              </div>
            `;
          }).join('')}
          </div>
        `}

        ${canAdd ? `
          <button onclick="newPlan()" class="w-full pc-btn pc-btn-secondary">+ Create Training Plan</button>
        ` : `
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
            <p class="text-orange-800">Free: 1 plan max. Upgrade to Pro for unlimited!</p>
          </div>
        `}
      `;
    }

    function renderSettingsView(root) {
      root.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
          <h2 class="text-2xl font-bold">Settings</h2>
          <div class="w-16"></div>
        </div>

        ${app.showClearConfirm ? `
          <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-4">
            <p class="font-bold text-red-900 mb-2">Clear All Data?</p>
            <p class="text-sm text-red-800 mb-3">This will delete all routines, plans, and history. This cannot be undone!</p>
            <div class="flex gap-3">
              <button onclick="confirmClearStorage()" class="flex-1 pc-btn pc-btn-danger">Clear All Data</button>
              <button onclick="cancelClearStorage()" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
            </div>
          </div>
        ` : ''}

        <div class="pc-card p-6 mb-4">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="font-bold">Pro Version</h3>
              <p class="text-sm text-gray-600">Unlock all features</p>
            </div>
            <button onclick="togglePro()" class="px-4 py-2 rounded-lg ${app.isPro ? 'bg-green-600 text-white' : 'bg-gray-200'}">
              ${app.isPro ? '‚úì Active' : 'Enable'}
            </button>
          </div>

          <div class="text-sm text-gray-600 space-y-1">
            <p>‚Ä¢ Unlimited routines (Free: 3)</p>
            <p>‚Ä¢ Routines any length (Free: 30 min max)</p>
            <p>‚Ä¢ Unlimited training plans (Free: 1)</p>
            <p>‚Ä¢ Full history (Free: last 3)</p>
            <p>‚Ä¢ Full statistics (Free: balls only)</p>
          </div>
        </div>

        <button onclick="clearStorage()" class="w-full pc-btn pc-btn-danger">
          Clear All Data & Reset
        </button>
      `;
    }

    window.addSegment = () => {
      if (!app.editRoutine.segments) app.editRoutine.segments = [];
      app.editRoutine.segments.push({ name: '', minutes: 5 });
      render();
    };

    window.removeSegment = (i) => {
      app.editRoutine.segments.splice(i, 1);
      render();
    };

    window.saveRoutine = () => {
      const name = document.getElementById('rname').value.trim();
      if (!name) return alert('Name required');

      const segments = [];
      document.querySelectorAll('.segment-row').forEach((row, i) => {
        const n = row.querySelector('.seg-name').value.trim();
        const m = parseInt(row.querySelector('.seg-mins').value) || 0;
        if (n && m > 0) segments.push({ name: n, minutes: m });
      });

      if (segments.length === 0) return alert('Add at least one segment');

      const total = segments.reduce((s, seg) => s + seg.minutes, 0);
      if (!app.isPro && total > 30) return alert('Free version limited to 30 minutes');

      if (app.editRoutine.isNew) {
        app.routines.push({ id: app.editRoutine.id, name, segments });
      } else {
        const r = app.routines.find(r => r.id === app.editRoutine.id);
        r.name = name;
        r.segments = segments;
      }

      app.editRoutine = null;
      app.view = 'routines';
      save();
      render();
    };

    // Plan actions
    window.newPlan = () => {
      app.editPlan = {
        id: Date.now().toString(),
        name: '',
        goalType: 'minutes',
        goalValue: 300,
        startDate: new Date().toISOString().split('T')[0],
        isNew: true
      };
      app.view = 'editPlan';
      render();
    };

    window.editPlanById = (id) => {
      app.editPlan = app.plans.find(p => p.id === id);
      app.view = 'editPlan';
      render();
    };

    window.deletePlan = (id) => {
      const plan = app.plans.find(p => p.id === id);
      app.deletePlanConfirm = { id, name: plan?.name || 'this plan' };
      const root = document.getElementById('app');
      if (app.view === 'plans') {
        renderPlansView(root);
      }
    };

    window.confirmDeletePlan = () => {
      if (app.activePlanId === app.deletePlanConfirm.id) {
        app.activePlanId = null;
      }
      app.plans = app.plans.filter(p => p.id !== app.deletePlanConfirm.id);
      app.deletePlanConfirm = null;
      save();
      const root = document.getElementById('app');
      if (app.view === 'plans') {
        renderPlansView(root);
      }
    };

    window.cancelDeletePlan = () => {
      app.deletePlanConfirm = null;
      const root = document.getElementById('app');
      if (app.view === 'plans') {
        renderPlansView(root);
      }
    };

    window.setActivePlan = (id) => {
      app.activePlanId = id;
      save();
      render();
    };

    window.deactivatePlan = () => {
      app.activePlanId = null;
      save();
      render();
    };

    window.savePlan = () => {
      const name = document.getElementById('planName').value.trim();
      const goalType = document.getElementById('goalType').value;
      const goalValue = parseInt(document.getElementById('goalValue').value) || 0;
      const startDate = document.getElementById('startDate').value;

      if (!name) return alert('Name required');
      if (goalValue <= 0) return alert('Goal value must be greater than 0');

      if (app.editPlan.isNew) {
        app.plans.push({
          id: app.editPlan.id,
          name,
          goalType,
          goalValue,
          startDate
        });
      } else {
        const p = app.plans.find(p => p.id === app.editPlan.id);
        p.name = name;
        p.goalType = goalType;
        p.goalValue = goalValue;
        p.startDate = startDate;
      }

      app.editPlan = null;
      app.view = 'plans';
      save();
      render();
    };

    window.resetPlan = (id) => {
      const plan = app.plans.find(p => p.id === id);
      if (plan) {
        plan.startDate = new Date().toISOString().split('T')[0];
        plan.progress = { minutes: 0, balls: 0, sessions: 0 };
        save();
        const root = document.getElementById('app');
        if (app.view === 'plans') {
          renderPlansView(root);
        }
      }
    };

    window.requestResetStats = (period) => {
      const msg =
        period === 'week'
          ? 'Delete all sessions from the past 7 days?'
          : period === 'month'
          ? 'Delete all sessions from the past 30 days?'
          : period === 'lifetime'
          ? 'Reset lifetime statistics? (This will NOT delete session history.)'
          : 'Delete ALL session history? This cannot be undone!';
      app.statsResetConfirm = { period, msg };
      render();
    };

    window.cancelResetStats = () => {
      app.statsResetConfirm = null;
      render();
    };

    window.confirmResetStats = () => {
      const c = app.statsResetConfirm;
      if (!c) return;
      app.statsResetConfirm = null;
      resetStats(c.period);
    };

    window.resetStats = (period) => {
      const now = new Date();

      if (period === 'week') {
        app.statsResetWeekAt = now.toISOString();
        save();
        render();
        return;
      } else if (period === 'month') {
        app.statsResetMonthAt = now.toISOString();
        save();
        render();
        return;
      } else if (period === 'lifetime') {
        app.statsResetLifetimeAt = now.toISOString();
        save();
        render();
        return;
      } else if (period === 'all') {
        app.history = [];
        save();
        render();
        return;
      }

      save();
      render();
    }

    // Render
    function render() {
      console.log('=== RENDER START ===');
      console.log('Current view:', app.view);
      console.log('deleteConfirm:', app.deleteConfirm);

      const root = document.getElementById('app');

      if (!root) {
        console.error('Root element not found!');
        return;
      }

      // Clean up any existing overlay
      const existingOverlay = document.querySelector('.upgrade-overlay');
      if (existingOverlay) {
        existingOverlay.remove();
      }

      console.log('About to check view conditions...');

      if (app.view === 'home') {
        console.log('>> MATCHED: home');
        const latestNote = app.history[0]?.notes || '';
        const activePlan = app.plans.find(p => p.id === app.activePlanId);

        let planProgress = null;
        if (activePlan) {
          if (!activePlan.progress) {
            activePlan.progress = { minutes: 0, balls: 0, sessions: 0 };
          }

          let current = 0;
          if (activePlan.goalType === 'minutes') {
            current = activePlan.progress.minutes;
          } else if (activePlan.goalType === 'balls') {
            current = activePlan.progress.balls;
          } else if (activePlan.goalType === 'sessions') {
            current = activePlan.progress.sessions;
          }

          planProgress = {
            current,
            goal: activePlan.goalValue,
            percent: Math.min((current / activePlan.goalValue) * 100, 100)
          };
        }

        root.innerHTML = `
          <div class="pc-card p-6 mb-4">
            <div class="flex justify-between items-center">
              <h1 class="text-3xl font-bold text-[#2F6F4E]">Practice Caddie</h1>
              <button onclick="goTo('settings')" class="p-2 hover:bg-gray-100 rounded">‚öôÔ∏è</button>
            </div>
            <div class="pc-accent-rule mt-4"></div>
            ${!app.isPro ? '<div class="text-sm text-orange-600 font-medium mt-2">Free Version</div>' : ''}
          </div>

          ${latestNote ? `
            <div class="bg-[#EEF4F0] border-l-4 border-[#2F6F4E] p-4 mb-4 rounded-r-lg">
              <p class="text-sm font-medium text-[#1F2A24]">Last Session Note:</p>
              <p class="text-sm text-[#5F6D64] mt-1">${latestNote}</p>
            </div>
          ` : ''}

          ${activePlan ? `
            <div class="pc-card p-4 mb-4">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h3 class="font-bold text-gray-800">Active Training Plan</h3>
                  <p class="text-lg font-semibold text-[#2F6F4E]">${activePlan.name}</p>
                </div>
                <button onclick="deactivatePlan()" class="text-sm text-red-600 hover:underline">Deactivate</button>
              </div>
              <div class="mb-2">
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-600">${planProgress.current} / ${planProgress.goal} ${activePlan.goalType}</span>
                  <span class="text-gray-600">${planProgress.percent.toFixed(0)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                  <div class="bg-green-600 h-3 rounded-full transition-all" style="width:${planProgress.percent}%"></div>
                </div>
              </div>
            </div>
          ` : ''}

                    <div class="grid grid-cols-2 gap-4">
            <button onclick="goTo('routines')" class="pc-tile">
              <div class="pc-tile-icon">‚ñ∂</div>
              <div class="font-semibold">Routines</div>
              <div class="text-sm text-[#5F6D64] mt-1">Build & run practice</div>
            </button>
            <button onclick="goTo('plans')" class="pc-tile">
              <div class="pc-tile-icon">‚õ≥</div>
              <div class="font-semibold">Training Plans</div>
              <div class="text-sm text-[#5F6D64] mt-1">Track progress</div>
            </button>
            <button onclick="goTo('history')" class="pc-tile">
              <div class="pc-tile-icon">üóí</div>
              <div class="font-semibold">History</div>
              <div class="text-sm text-[#5F6D64] mt-1">Sessions & notes</div>
            </button>
            <button onclick="goTo('stats')" class="pc-tile">
              <div class="pc-tile-icon">üìà</div>
              <div class="font-semibold">Statistics</div>
              <div class="text-sm text-[#5F6D64] mt-1">Trends over time</div>
            </button>
          </div>

          ${!app.isPro ? `
            <div class="mt-6 text-center">
              <button onclick="showUpgrade()" class="pc-link font-semibold underline">
                Upgrade to Pro ‚Üí
              </button>
            </div>
          ` : ''}
        `;
      }

      else if (app.view === 'routines') {
        const canAdd = app.isPro || app.routines.length < 3;
        root.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
            <h2 class="text-2xl font-bold">Routines</h2>
            <div class="w-16"></div>
          </div>

          ${app.routines.length === 0 ? `
            <div class="pc-card p-8 text-center mb-4">
              <p class="text-gray-600">No routines yet!</p>
            </div>
          ` : `
            <div class="space-y-4 mb-4">
              ${app.routines.map(r => `
                <div class="pc-card p-4">
                  <div class="flex justify-between mb-2">
                    <div>
                      <h3 class="font-bold text-lg">${r.name}</h3>
                      <p class="text-sm text-gray-600">${r.segments.length} segments ‚Ä¢ ${r.segments.reduce((s,g) => s + g.minutes, 0)} min</p>
                    </div>
                    <div class="flex gap-2">
                      <button onclick="editRoutineById('${r.id}')" class="p-2 hover:bg-gray-100 rounded">‚úèÔ∏è</button>
                      <button onclick="deleteRoutine('${r.id}')" class="p-2 hover:bg-gray-100 rounded">üóëÔ∏è</button>
                    </div>
                  </div>
                  <button onclick="startRoutine('${r.id}')" class="w-full pc-btn pc-btn-primary">Start</button>
                </div>
              `).join('')}
            </div>
          `}

          ${canAdd ? `
            <button onclick="newRoutine()" class="w-full pc-btn pc-btn-secondary">+ Create Routine</button>
          ` : `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
              <p class="text-orange-800">Free: 3 routines max. Upgrade to Pro!</p>
            </div>
          `}
        `;
      }

      else if (app.view === 'editRoutine') {
        console.log('HIT EDIT ROUTINE BLOCK');
        const total = (app.editRoutine.segments || []).reduce((s, seg) => s + seg.minutes, 0);
        const exceeds = !app.isPro && total > 30;
        root.innerHTML = `
          <h2 class="text-2xl font-bold mb-6">${app.editRoutine.isNew ? 'Create' : 'Edit'} Routine</h2>

          <div class="pc-card p-6 mb-4">
            <label class="block text-sm font-medium mb-2">Name</label>
            <input type="text" id="rname" value="${app.editRoutine.name}" class="pc-input pc-focus mb-4" placeholder="Monday Practice">

            <div class="border-t pt-4 mb-4">
              <h3 class="font-bold mb-3">Quick Setup</h3>
              <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                  <label class="block text-xs font-medium mb-1">Total Minutes</label>
                  <input type="number" id="quickTotal" value="${app.quickSetup.totalMinutes}" class="pc-input pc-focus" min="5">
                </div>
                <div>
                  <label class="block text-xs font-medium mb-1">Number of Drills</label>
                  <input type="number" id="quickDrills" value="${app.quickSetup.numDrills}" class="pc-input pc-focus" min="1">
                </div>
              </div>
              <button onclick="quickGenerate()" class="w-full pc-btn pc-btn-secondary text-sm">
                Generate Routine
              </button>
            </div>

            <div class="flex justify-between mb-4">
              <h3 class="font-bold">Segments</h3>
              <span class="text-sm ${exceeds ? 'text-red-600 font-bold' : 'text-gray-600'}">
                Total: ${total} min ${exceeds ? '(Max 30 for Free!)' : ''}
              </span>
            </div>

            <div class="space-y-3 mb-4">
              ${(app.editRoutine.segments || []).map((s, i) => `
                <div class="segment-row flex gap-2 bg-gray-50 p-3 rounded-lg">
                  <input type="text" class="seg-name pc-input pc-focus" value="${s.name}" placeholder="Segment name" style="flex: 1 1 0; min-width: 0;">
                  <input type="number" class="seg-mins pc-input pc-focus" value="${s.minutes}" min="1" style="width: 3.5rem; flex: 0 0 auto;">
                  <span class="text-sm text-gray-600 self-center" style="flex: 0 0 auto;">min</span>
                  <button onclick="removeSegment(${i})" class="p-1 hover:bg-gray-200 rounded" style="flex: 0 0 auto;">üóëÔ∏è</button>
                </div>
              `).join('')}
            </div>

            <button onclick="addSegment()" class="w-full border-2 border-dashed border-gray-300 rounded-lg py-2 hover:border-gray-400">+ Add Segment Manually</button>
          </div>

          <div class="flex gap-3">
            <button onclick="saveRoutine()" class="flex-1 pc-btn pc-btn-primary">Save</button>
            <button onclick="goTo('routines')" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
          </div>
        `;
      }

      else if (app.view === 'session') {
        console.log('HIT SESSION BLOCK');
        const seg = app.session.segments[app.segmentIndex];
        const m = Math.floor(app.timeLeft / 60);
        const s = app.timeLeft % 60;
        root.innerHTML = `
          <div class="min-h-screen pc-session-bg flex items-center justify-center p-4 -m-4">
            <div class="pc-card-strong p-8 max-w-md w-full">
              <h2 class="text-2xl font-bold text-center mb-2">${app.session.name}</h2>
              <div class="text-center text-gray-600 mb-6">Segment ${app.segmentIndex + 1} of ${app.session.segments.length}</div>

              <div class="bg-[#EEF4F0] rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-center mb-4">${seg.name}</h3>
                <div class="text-6xl font-bold text-center text-[#2F6F4E]">${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}</div>
              </div>

            <div class="space-y-3">
              <div class="flex gap-3">
                ${app.isPaused
                  ? '<button onclick="continueRoutine()" class="w-1/2 pc-btn pc-btn-secondary">‚ñ∂Ô∏è Continue</button>'
                  : '<button onclick="pauseRoutine()" class="w-1/2 pc-btn pc-btn-secondary">‚è∏Ô∏è Pause</button>'
                }
                <button onclick="skipSegment()" class="w-1/2 pc-btn pc-btn-secondary">‚è≠Ô∏è Skip</button>
              </div>
              <button onclick="endSession()" class="w-full pc-btn pc-btn-danger">‚èπÔ∏è End</button>
            </div>

              <div class="mt-6 pt-6 border-t text-sm">
                ${app.session.segments.map((sg, i) => `
                  <div class="py-1 ${i === app.segmentIndex ? 'font-bold text-[#2F6F4E]' : ''} ${i < app.segmentIndex ? 'line-through text-gray-400' : ''}">${sg.name} (${sg.minutes} min)</div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }

      else if (app.view === 'complete') {
        console.log('HIT COMPLETE BLOCK');
        root.innerHTML = `
          <div class="pc-card p-6 mt-8 max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-center mb-6 text-[#2F6F4E]">Session Complete!</h2>

            <div class="space-y-4 mb-6">
              <div>
                <label class="block text-sm font-medium mb-2">Balls Hit</label>
                <input type="number" id="balls" class="pc-input pc-focus" placeholder="0">
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Rate (0-5)</label>
                <div class="flex gap-2 justify-center">
                  ${[0,1,2,3,4,5].map(v => `<button onclick="selectRating(${v})" data-rating="${v}" class="w-12 h-12 rounded-lg border-2 font-bold bg-white text-gray-600 border-gray-300">${v}</button>`).join('')}
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Notes</label>
                <textarea id="notes" class="pc-input pc-focus h-24" placeholder="How did it go?"></textarea>
              </div>
            </div>

            <div class="flex gap-3">
              <button onclick="saveSession()" class="flex-1 pc-btn pc-btn-primary">Save</button>
              <button onclick="discardSession()" class="flex-1 pc-btn pc-btn-secondary">Discard</button>
            </div>
          </div>
        `;
      }

      else if (app.view === 'plans') {
        console.log('HIT PLANS BLOCK');
        renderPlansView(root);
      }

      else if (app.view === 'editPlan') {
        console.log('HIT EDIT PLAN BLOCK');
        root.innerHTML = `
          <h2 class="text-2xl font-bold mb-6">${app.editPlan.isNew ? 'Create' : 'Edit'} Training Plan</h2>

          <div class="pc-card p-6 mb-4">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium mb-2">Plan Name</label>
                <input type="text" id="planName" value="${app.editPlan.name}" class="pc-input pc-focus" placeholder="e.g. January Goal">
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Goal Type</label>
                <select id="goalType" class="pc-input pc-focus">
                  <option value="minutes" ${app.editPlan.goalType === 'minutes' ? 'selected' : ''}>Minutes</option>
                  <option value="balls" ${app.editPlan.goalType === 'balls' ? 'selected' : ''}>Balls</option>
                  <option value="sessions" ${app.editPlan.goalType === 'sessions' ? 'selected' : ''}>Sessions</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Goal Value</label>
                <input type="number" id="goalValue" value="${app.editPlan.goalValue}" class="pc-input pc-focus" min="1">
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">Start Date</label>
                <input type="date" id="startDate" value="${app.editPlan.startDate}" class="pc-input pc-focus">
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="savePlan()" class="flex-1 pc-btn pc-btn-primary">Save</button>
            <button onclick="goTo('plans')" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
          </div>
        `;
      }

      else if (app.view === 'stats') {
        console.log('HIT STATS BLOCK');
        const now = new Date();
        const day7 = now - 7 * 24 * 60 * 60 * 1000;
        const day30 = now - 30 * 24 * 60 * 60 * 1000;

        const calc = (sessions) => ({
          balls: sessions.reduce((s, h) => s + (h.ballsHit || 0), 0),
          minutes: sessions.reduce((s, h) => s + (h.totalMinutes || 0), 0),
          sessions: sessions.length,
          avgRating: sessions.length ? (sessions.reduce((s, h) => s + (h.rating || 0), 0) / sessions.length).toFixed(1) : 0
        });

        const weekResetAt = app.statsResetWeekAt ? new Date(app.statsResetWeekAt).getTime() : 0;
        const monthResetAt = app.statsResetMonthAt ? new Date(app.statsResetMonthAt).getTime() : 0;
        const lifetimeResetAt = app.statsResetLifetimeAt ? new Date(app.statsResetLifetimeAt).getTime() : 0;

        const stats = {
          week: calc(app.statsHistory.filter(h => {
            const t = new Date(h.date).getTime();
            return t >= day7 && t >= weekResetAt;
          })),
          month: calc(app.statsHistory.filter(h => {
            const t = new Date(h.date).getTime();
            return t >= day30 && t >= monthResetAt;
          })),
          lifetime: calc(app.statsHistory.filter(h => {
            const t = new Date(h.date).getTime();
            return t >= lifetimeResetAt;
          }))
        };

        const blur = !app.isPro ? 'filter blur-sm' : '';

        root.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
            <h2 class="text-2xl font-bold">Statistics</h2>
            <div class="w-16"></div>
          </div>

          ${!app.isPro ? `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4 text-center">
              <p class="text-orange-800">Free users see balls only. Upgrade to Pro for full statistics!</p>
            </div>
          ` : ''}

          <div class="pc-card p-6 mb-4">
            <div class="overflow-x-auto">
              <table class="w-full text-center">
                <thead>
                  <tr class="border-b-2 border-gray-300">
                    <th class="py-3 px-2 text-left font-bold text-gray-700"></th>
                    <th class="py-3 px-2 font-bold text-gray-700">Past 7 Days</th>
                    <th class="py-3 px-2 font-bold text-gray-700">Past 30 Days</th>
                    <th class="py-3 px-2 font-bold text-gray-700">Lifetime</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-b border-gray-200">
                    <td class="py-3 px-2 text-left font-medium text-gray-700">Balls</td>
                    <td class="py-3 px-2 text-2xl font-bold text-[#2F6F4E]">${stats.week.balls}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-[#2F6F4E]">${stats.month.balls}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-[#2F6F4E]">${stats.lifetime.balls}</td>
                  </tr>
                  <tr class="border-b border-gray-200 ${blur}">
                    <td class="py-3 px-2 text-left font-medium text-gray-700">Minutes</td>
                    <td class="py-3 px-2 text-2xl font-bold text-blue-600">${stats.week.minutes}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-blue-600">${stats.month.minutes}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-blue-600">${stats.lifetime.minutes}</td>
                  </tr>
                  <tr class="border-b border-gray-200 ${blur}">
                    <td class="py-3 px-2 text-left font-medium text-gray-700">Sessions</td>
                    <td class="py-3 px-2 text-2xl font-bold text-purple-600">${stats.week.sessions}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-purple-600">${stats.month.sessions}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-purple-600">${stats.lifetime.sessions}</td>
                  </tr>
                  <tr class="${blur}">
                    <td class="py-3 px-2 text-left font-medium text-gray-700">Avg Rating</td>
                    <td class="py-3 px-2 text-2xl font-bold text-orange-600">${stats.week.avgRating}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-orange-600">${stats.month.avgRating}</td>
                    <td class="py-3 px-2 text-2xl font-bold text-orange-600">${stats.lifetime.avgRating}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="pc-card p-4">
            <h3 class="font-bold text-gray-800 mb-3">Reset Statistics</h3>

            ${app.statsResetConfirm ? `
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                <p class="text-sm text-red-800 font-medium mb-3">${app.statsResetConfirm.msg}</p>
                <div class="flex gap-3">
                  <button onclick="confirmResetStats()" class="flex-1 pc-btn pc-btn-danger">Confirm</button>
                  <button onclick="cancelResetStats()" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
                </div>
              </div>
            ` : ''}

            <div class="grid grid-cols-2 gap-3">
              <button onclick="requestResetStats('week')" class="pc-btn pc-btn-danger">Reset 7 Days</button>
              <button onclick="requestResetStats('month')" class="pc-btn pc-btn-danger">Reset 30 Days</button>
              <button onclick="requestResetStats('lifetime')" class="col-span-2 pc-btn pc-btn-danger">Reset Lifetime Statistics</button>
            </div>
          </div>
        `;
      }

      else if (app.view === 'history') {
        console.log('HIT HISTORY BLOCK');
        const visible = app.isPro ? app.history : app.history.slice(0, 3);
        root.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
            <h2 class="text-2xl font-bold">History</h2>
            <div class="w-16"></div>
          </div>

          ${!app.isPro && app.history.length > 3 ? `
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4 text-center">
              <p class="text-orange-800">Free: last 3 sessions. Upgrade for full history!</p>
            </div>
          ` : ''}

          ${visible.length === 0 ? `
            <div class="pc-card p-8 text-center">
              <p class="text-gray-600">No sessions yet!</p>
            </div>
          ` : `
            <div class="space-y-4">
              ${visible.map(h => `
                <div class="pc-card p-4">
                  <div class="flex justify-between mb-2">
                    <div>
                      <h3 class="font-bold">${h.routineName}</h3>
                      <p class="text-sm text-gray-600">${new Date(h.date).toLocaleDateString()}</p>
                    </div>
                    <div class="text-right">
                      <div class="font-bold text-[#2F6F4E]">${h.ballsHit} balls</div>
                      <div class="text-sm text-gray-600">${h.totalMinutes} min ‚Ä¢ ‚≠ê${h.rating}</div>
                    </div>
                  </div>
                  ${h.notes ? `<p class="text-sm text-gray-700 mt-2 p-2 bg-[#EEF4F0] rounded">${h.notes}</p>` : ''}
                </div>
              `).join('')}
            </div>
          `}

          <div class="pc-card p-4 mt-4">
            <h3 class="font-bold text-gray-800 mb-3">Reset History</h3>

            ${app.statsResetConfirm ? `
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                <p class="text-sm text-red-800 font-medium mb-3">${app.statsResetConfirm.msg}</p>
                <div class="flex gap-3">
                  <button onclick="confirmResetStats()" class="flex-1 pc-btn pc-btn-danger">Confirm</button>
                  <button onclick="cancelResetStats()" class="flex-1 pc-btn pc-btn-secondary">Cancel</button>
                </div>
              </div>
            ` : ''}

            <button onclick="requestResetStats('all')" class="w-full pc-btn pc-btn-danger">Reset All History</button>
          </div>
        `;
      }

      else if (app.view === 'settings') {
        console.log('HIT SETTINGS BLOCK');
        root.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <button onclick="goTo('home')" class="pc-link">‚Üê Back</button>
            <h2 class="text-2xl font-bold">Settings</h2>
            <div class="w-16"></div>
          </div>

          <div class="pc-card p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <div>
                <h3 class="font-bold">Pro Version</h3>
                <p class="text-sm text-gray-600">Unlock all features</p>
              </div>
              <button onclick="togglePro()" class="px-4 py-2 rounded-lg ${app.isPro ? 'bg-green-600 text-white' : 'bg-gray-200'}">
                ${app.isPro ? '‚úì Active' : 'Enable'}
              </button>
            </div>

            <div class="text-sm text-gray-600 space-y-1">
              <p>‚Ä¢ Unlimited routines (Free: 3)</p>
              <p>‚Ä¢ Routines any length (Free: 30 min max)</p>
              <p>‚Ä¢ Full history (Free: last 3)</p>
            </div>
          </div>

          <div class="pc-card p-6 mb-4">
            <h3 class="font-bold mb-3">About Practice Caddie</h3>
            <div class="text-sm text-gray-700 space-y-2">
              <p><strong>Version:</strong> 1.1</p>
              <p>Practice Caddie helps golfers structure and track their practice sessions with custom routines, timers, and detailed statistics.</p>
            </div>
          </div>

          <div class="pc-card p-6 mb-4">
            <h3 class="font-bold mb-3">Contact & Support</h3>
            <div class="text-sm text-gray-700 space-y-2">
              <p><strong>Email:</strong> support@practicecaddie.com</p>
              <p><strong>Website:</strong> www.practicecaddie.com</p>
              <p>For bug reports, feature requests, or general support, please contact us via email.</p>
            </div>
          </div>

          <div class="pc-card p-6 mb-4">
            <h3 class="font-bold mb-3">Privacy Policy</h3>
            <div class="text-sm text-gray-700 space-y-2">
              <p><strong>Data Storage:</strong> All practice data is stored locally on your device. We do not collect, transmit, or store any personal information on external servers.</p>
              <p><strong>Analytics:</strong> This app does not use analytics or tracking services.</p>
              <p><strong>Permissions:</strong> This app does not require any special device permissions beyond basic storage for saving your practice data.</p>
              <p><strong>Data Deletion:</strong> You can delete all app data at any time using the "Clear All Data & Reset" button below.</p>
              <p>For our complete privacy policy, visit: www.practicecaddie.com/privacy</p>
            </div>
          </div>

          <div class="pc-card p-6 mb-4">
            <h3 class="font-bold mb-3">Terms of Service</h3>
            <div class="text-sm text-gray-700 space-y-2">
              <p>By using Practice Caddie, you agree to use the app for lawful purposes only. The app is provided "as is" without warranties of any kind.</p>
              <p>For complete terms of service, visit: www.practicecaddie.com/terms</p>
            </div>
          </div>

          <button onclick="clearStorage()" class="w-full pc-btn pc-btn-danger mb-4">
            Clear All Data & Reset
          </button>

          <div class="text-center text-sm text-gray-500">
            <p>¬© 2025 Practice Caddie. All rights reserved.</p>
          </div>
        `;
      }

      // Upgrade overlay
      if (app.showUpgradeOverlay) {
        const overlay = document.createElement('div');
        overlay.className = 'upgrade-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
        overlay.onclick = (e) => {
          if (e.target === overlay) closeUpgrade();
        };

        overlay.innerHTML = `
          <div class="pc-card-strong max-w-md w-full p-6" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Upgrade to Pro</h2>
              <button onclick="closeUpgrade()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="mb-6">
              <h3 class="font-bold text-gray-800 mb-3">Free Version</h3>
              <div class="text-sm text-gray-600 space-y-2">
                <p>‚úì Up to 3 custom routines</p>
                <p>‚úì 30 minute max per routine</p>
                <p>‚úì 1 custom training plan</p>
                <p>‚úì Last 3 sessions in history</p>
                <p>‚úì Ball count tracking</p>
              </div>
            </div>

            <div class="mb-6">
              <h3 class="font-bold text-[#2F6F4E] mb-3">Pro Version</h3>
              <div class="text-sm text-gray-700 space-y-2">
                <p>‚úì <strong>Unlimited</strong> custom routines</p>
                <p>‚úì <strong>Unlimited</strong> routine length</p>
                <p>‚úì <strong>Unlimited</strong> training plans</p>
                <p>‚úì Training plan progress</p>
                <p>‚úì <strong>Full</strong> session history</p>
                <p>‚úì Complete statistics tracking</p>
                <p>‚úì Session ratings and notes</p>
              </div>
            </div>

            <div class="space-y-3">
              <button onclick="upgradeToPro()" class="w-full pc-btn pc-btn-primary">
                Upgrade Now
              </button>
              <button onclick="closeUpgrade()" class="w-full pc-btn pc-btn-secondary">
                Maybe Later
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(overlay);
      }
    }

    load();
</script>
</body>
</html>
